<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurus Tracker Pro | Live Sync</title>
<style>
:root { --excel-green: #217346; --bg: #f0f2f5; --text: #1a202c; --border: #e2e8f0; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }

/* HEADER & DASHBOARD */
.header-container { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
#liveClock { font-weight: 700; color: #4a5568; background: #edf2f7; padding: 8px 15px; border-radius: 20px; font-size: 13px; }

/* SEPARATED TABLES */
.status-section { background: #fff; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; overflow: hidden; }
.section-header { padding: 12px 20px; font-weight: 800; color: #fff; display: flex; justify-content: space-between; font-size: 14px; }
.bg-working { background: #3182ce; } .bg-done { background: var(--excel-green); } .bg-stuck { background: #e53e3e; }

.table-wrapper { overflow-x: auto; max-height: 40vh; }
table { width: 100%; border-collapse: collapse; min-width: 1500px; }
th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; padding: 12px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; cursor: pointer; }
td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; text-align: center; min-width: 100px; }

/* COLORED CELLS */
.cell-yes { background-color: #c6f6d5 !important; color: #22543d !important; font-weight: bold; }
.cell-no { background-color: #fed7d7 !important; color: #822727 !important; font-weight: bold; }
.cell-na { background-color: #edf2f7 !important; }

/* CONTEXT MENU & INPUTS */
.context-menu { position: absolute; background: #fff; border: 1px solid #ddd; box-shadow: 0 8px 16px rgba(0,0,0,0.1); z-index: 10000; border-radius: 8px; padding: 8px 0; list-style: none; display: none; min-width: 200px; }
.context-menu li { padding: 10px 20px; font-size: 13px; cursor: pointer; }
.context-menu li:hover { background: #f7fafc; color: var(--excel-green); }
.suggestion-box { position: absolute; background: white; border: 1px solid #cbd5e0; z-index: 5000; max-height: 150px; overflow-y: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-radius: 6px; min-width: 200px; list-style: none; padding: 0; margin: 0; text-align: left; }
.suggestion-box li { padding: 8px 15px; cursor: pointer; font-size: 12px; }
.suggestion-box li:hover { background: #ebf8ff; color: #3182ce; }
input[type="date"], select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; width: 95%; background: white; }
.btn-admin { background: #2d3748; color: #fff; padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
</style>
</head>
<body>

<div class="header-container">
  <div>
    <h1>Aurus <span style="color:var(--excel-green)">Tracker Pro</span></h1>
    <div style="display:flex; gap:15px; margin-top:5px; align-items:center;">
        <div id="liveClock">Loading Clock...</div>
        <div id="syncStatus" style="font-size:11px; font-weight:bold; color:#718096;">Sync: Ready</div>
    </div>
  </div>
  <div style="display:flex; gap:10px;">
    <button id="manageNamesBtn" class="btn-admin" style="display:none; background:var(--excel-green);" onclick="toggleTeamManager()">üë• Manage Names</button>
    <button id="adminBtn" class="btn-admin" onclick="toggleAdmin()">üîí Admin Mode</button>
  </div>
</div>

<ul id="contextMenu" class="context-menu">
  <li onclick="renameColumnContext()">‚úèÔ∏è Rename Column</li>
  <li onclick="addColumnContext()">üìä Add Column (Right)</li>
  <li onclick="deleteColumnContext()" style="color:red">‚úÇÔ∏è Delete Column</li>
  <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
  <li onclick="addRowContext()">‚ûï Add New Row</li>
  <li onclick="deleteRowContext()" style="color:red">üóëÔ∏è Delete Row</li>
</ul>

<div id="teamManager" style="display:none; background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
    <h3 style="margin:0 0 15px 0;">Team Member List (name.json)</h3>
    <div style="margin-bottom:15px;">
        <input type="text" id="newNameInput" placeholder="Add new name..." style="padding:8px; border:1px solid #ddd; border-radius:5px; width:250px;">
        <button class="btn-admin" style="background:var(--excel-green);" onclick="addNewName()">Add Member</button>
    </div>
    <div id="namesContainer"></div>
</div>

<div class="status-section">
    <div class="section-header bg-working"><span>‚è≥ WORKING / IN-PROGRESS</span><span id="countWorking">0</span></div>
    <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-working"></tbody></table></div>
</div>

<div class="status-section">
    <div class="section-header bg-done"><span>‚úÖ COMPLETED</span><span id="countDone">0</span></div>
    <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-completed"></tbody></table></div>
</div>

<div class="status-section">
    <div class="section-header bg-stuck"><span>üõë STUCK / YET TO START</span><span id="countStuck">0</span></div>
    <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-stuck"></tbody></table></div>
</div>

<script>
const GH_CONFIG = { owner: 'Studnit', repo: 'monday.com', dataPath: 'data.json', namePath: 'name.json' };
const GITHUB_TOKEN = "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";  // PASTE TOKEN

let DATA = [], TEAM_NAMES = [], HEADERS = [];
let admin = false, activeCell = null, autosaveTimer = null;

function startClock() {
    setInterval(() => {
        document.getElementById('liveClock').innerText = "üìÖ " + new Date().toLocaleString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
    }, 1000); // Live date/time display
}

async function loadAllData() {
    try {
        const nameUrl = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`;
        const nameRes = await fetch(nameUrl);
        TEAM_NAMES = JSON.parse(atob((await nameRes.json()).content));
        renderTeamManager();

        const dataUrl = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`;
        const dataRes = await fetch(dataUrl);
        const dataJson = await dataRes.json();
        const content = JSON.parse(atob(dataJson.content));
        DATA = content.data || [];
        HEADERS = content.headers || [];
        
        renderHeaders(); renderBodies();
    } catch (e) { console.error("Sync Failed"); }
}

function renderHeaders() {
    const html = HEADERS.map(h => `<th>${h}</th>`).join('');
    document.querySelectorAll(".hRow").forEach(el => el.innerHTML = html);
}

function renderBodies() {
    const sections = { working: document.getElementById("tb-working"), done: document.getElementById("tb-completed"), stuck: document.getElementById("tb-stuck") };
    Object.values(sections).forEach(s => s.innerHTML = "");
    let counts = { working: 0, done: 0, stuck: 0 };
    let statusIdx = HEADERS.findIndex(h => h.toLowerCase().includes("status"));

    DATA.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.index = idx;
        tr.innerHTML = r.map((cell, cIdx) => {
            const h = HEADERS[cIdx].toLowerCase();
            let colorCls = cell === "YES" ? "cell-yes" : (cell === "NO" ? "cell-no" : (cell === "NA" ? "cell-na" : ""));
            
            if (h.includes("date") && admin) {
                return `<td><input type="date" value="${cell}" onchange="updateCell(${idx}, ${cIdx}, this.value)"></td>`;
            }
            if (h.includes("status") && !h.includes("week") && admin) {
                return `<td><select onchange="updateCell(${idx}, ${cIdx}, this.value)">
                    <option value="Working on it" ${cell==='Working on it'?'selected':''}>Working</option>
                    <option value="Done" ${cell==='Done'?'selected':''}>Done</option>
                    <option value="Stuck" ${cell==='Stuck'?'selected':''}>Stuck</option>
                    <option value="Yet to Start" ${cell==='Yet to Start'?'selected':''}>Yet to Start</option>
                </select></td>`;
            }
            const isName = h.includes("name") && !h.includes("project") && !h.includes("cert");
            return `<td contenteditable="${admin}" class="${colorCls}" 
                    oninput="${isName ? `handleNameInput(event, ${idx}, ${cIdx})` : `updateCell(${idx}, ${cIdx}, this.innerText)`}">${cell}</td>`;
        }).join('');
        
        const status = (statusIdx !== -1 && r[statusIdx]) ? r[statusIdx].toLowerCase() : "";
        if (status === "done") { sections.done.appendChild(tr); counts.done++; }
        else if (status.includes("stuck") || status.includes("yet")) { sections.stuck.appendChild(tr); counts.stuck++; }
        else { sections.working.appendChild(tr); counts.working++; }
    });
    document.getElementById("countWorking").innerText = counts.working;
    document.getElementById("countDone").innerText = counts.done;
    document.getElementById("countStuck").innerText = counts.stuck;
}

function updateCell(rIdx, cIdx, val) {
    DATA[rIdx][cIdx] = val;
    if(HEADERS[cIdx].toLowerCase().includes("status")) renderBodies(); 
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(saveDataToGitHub, 2000); // 2-sec autosave
}

function handleNameInput(e, rIdx, cIdx) {
    const query = e.target.innerText.trim().toLowerCase();
    const cell = e.target;
    document.querySelectorAll('.suggestion-box').forEach(b => b.remove());
    if (query.length < 1) return;
    const matches = TEAM_NAMES.filter(name => name.toLowerCase().includes(query));
    if (matches.length > 0) {
        const box = document.createElement('ul'); box.className = 'suggestion-box';
        matches.forEach(m => {
            const li = document.createElement('li'); li.innerText = m;
            li.onclick = () => { cell.innerText = m; updateCell(rIdx, cIdx, m); box.remove(); };
            box.appendChild(li);
        });
        cell.appendChild(box);
    }
}

async function saveDataToGitHub() {
    if (!admin) return;
    const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` }});
        const fileData = await res.json();
        const payload = btoa(unescape(encodeURIComponent(JSON.stringify({ headers: HEADERS, data: DATA }, null, 2))));
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Grid Manipulation Sync", content: payload, sha: fileData.sha })
        });
        document.getElementById("syncStatus").innerText = "Sync: ‚úÖ Saved " + new Date().toLocaleTimeString();
    } catch (e) { console.error("Save failed"); }
}

function toggleAdmin() {
    if(!admin && prompt("Admin Pass:") === "admin123") { 
        admin = true; 
        document.getElementById("manageNamesBtn").style.display = "block";
        document.getElementById("adminBtn").innerText = "üîì Exit Admin";
    } else { admin = false; document.getElementById("manageNamesBtn").style.display = "none"; document.getElementById("teamManager").style.display = "none"; document.getElementById("adminBtn").innerText = "üîí Admin Mode";}
    renderBodies();
}

// CONTEXT MENU LOGIC
document.addEventListener('contextmenu', e => {
    if(!admin) return;
    const td = e.target.closest('td'), th = e.target.closest('th');
    if(td || th) {
        e.preventDefault(); const menu = document.getElementById("contextMenu");
        menu.style.display = "block"; menu.style.left = e.pageX + "px"; menu.style.top = e.pageY + "px";
        activeCell = td || th;
    }
});
document.addEventListener('click', () => document.getElementById("contextMenu").style.display = "none");

function renameColumnContext() {
    const cIdx = activeCell.cellIndex; const newName = prompt("New Header Name:", HEADERS[cIdx]);
    if(newName) { HEADERS[cIdx] = newName; renderHeaders(); saveDataToGitHub(); }
}
function addColumnContext() {
    const colName = prompt("New Column Name:");
    if(colName) { HEADERS.push(colName); DATA.forEach(r => r.push("")); renderHeaders(); renderBodies(); saveDataToGitHub(); }
}
function deleteColumnContext() {
    const cIdx = activeCell.cellIndex;
    if(confirm(`Delete column "${HEADERS[cIdx]}"?`)) { HEADERS.splice(cIdx, 1); DATA.forEach(r => r.splice(cIdx, 1)); renderHeaders(); renderBodies(); saveDataToGitHub(); }
}
function addRowContext() { DATA.push(Array(HEADERS.length).fill("")); renderBodies(); saveDataToGitHub(); }
function deleteRowContext() { if(confirm("Delete Row?")) { DATA.splice(activeCell.parentElement.dataset.index, 1); renderBodies(); saveDataToGitHub(); }}

window.onload = () => { startClock(); loadAllData(); };
</script>
</body>
</html>
