<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aurus Tracker Pro | Advanced Grid & Admin Tools</title>
<style>
:root {
  --excel-green: #217346;
  --bg: #f4f7f6;
  --text: #1a202c;
  --border: #cbd5e0;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 15px;
  line-height: 1.4;
}
h1 { margin: 0; font-size: 20px; }
.header-container {
  display: flex; justify-content: space-between; align-items: center;
  background: #fff; padding: 12px 25px; border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; position: sticky; top: 0; z-index: 1000;
}
#liveClock { font-weight: 700; color: #4a5568; background: #edf2f7; padding: 6px 12px; border-radius: 20px; font-size: 13px; }
button {
  padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; font-size: 13px;
  transition: background 0.3s, transform 0.2s;
}
button:hover { transform: scale(1.02); }
.btn-save { background: var(--excel-green); color: #fff; }
.btn-admin { background: #2d3748; color: #fff; }
button:disabled { opacity: 0.6; cursor: not-allowed; }

.status-section {
  background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin-bottom: 25px; overflow: hidden; border: 1px solid var(--border);
}
.section-header {
  padding: 10px 20px; font-weight: 800; color: #fff; display: flex; justify-content: space-between; font-size: 14px;
}
.bg-working { background: #3182ce; }
.bg-done { background: var(--excel-green); }
.bg-stuck { background: #e53e3e; }
.table-wrapper {
  overflow: auto; max-height: 45vh; transition: max-height 0.3s ease;
}
table {
  width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1750px; table-layout: fixed;
}
th {
  background: #34495e; color: #fff; font-size: 11px; text-transform: uppercase; padding: 12px; border: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
th:nth-child(-n+3), td:nth-child(-n+3) {
  position: sticky; left: 0; z-index: 40; border-right: 1px solid var(--border);
}
th:nth-child(2), td:nth-child(2) { left: 50px; }
th:nth-child(3), td:nth-child(3) { left: 140px; }
th:nth-child(-n+3) { z-index: 101; background: #34495e; }
td {
  padding: 8px; border: 1px solid var(--border); font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: white;
}
td:nth-child(1) { background: #ebf5fb !important; font-weight: bold; width: 50px; }
td:nth-child(2) { background: #fdf2f2 !important; width: 90px; }
td:nth-child(3) { background: #e8f4fd !important; text-align: left; font-weight: 600; width: 350px; }

.bg-yes { background-color: #2ecc71 !important; color: white !important; font-weight: bold; }
.bg-no { background-color: #e74c3c !important; color: white !important; font-weight: bold; }
.bg-working-cell { background-color: #f39c12 !important; color: white !important; }
.bg-done-cell { background-color: #27ae60 !important; color: white !important; }
.bg-stuck-cell { background-color: #c0392b !important; color: white !important; }

.modal-overlay {
  display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10001; align-items:center; justify-content:center;
}
.modal-box {
  background:#fff; padding:25px; border-radius:12px; width:400px; border-top:6px solid var(--excel-green);
  display:flex; flex-direction:column; gap:15px;
}
.name-pill {
  display:inline-block; background:#edf2f7; padding:5px 10px; border-radius:15px; margin:3px; font-size:11px; font-weight:700; cursor:pointer;
}
.btn {
  padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; font-size: 12px; transition: background 0.3s;
}
.btn:hover { background: rgba(0,0,0,0.1); }
</style>
</head>
<body>

<!-- Modal for team management -->
<div id="teamModal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin:0 0 15px 0;">üë• Team Management</h3>
    <div style="display:flex; gap:10px;">
      <input type="text" id="newNameInput" placeholder="Add Name..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
      <button class="btn btn-save" onclick="addNewName()">Add</button>
    </div>
    <div id="namesContainer" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:5px; margin-top:10px;"></div>
    <div style="margin-top:15px; text-align:right;">
      <button class="btn btn-admin" onclick="closeTeamModal()">Close</button>
    </div>
  </div>
</div>

<!-- Header -->
<div class="header-container">
  <div>
    <h1>Aurus Certification <span style="color:var(--excel-green)">Pro Grid</span></h1>
    <div style="display:flex; gap:12px; margin-top:4px; align-items:center;">
      <div id="liveClock">Loading...</div>
      <div id="syncStatus" style="font-size:11px; font-weight:bold; color:#718096;">Sync: Ready</div>
    </div>
  </div>
  <div style="display:flex; gap:8px;">
    <button id="manageNamesBtn" class="btn btn-save" style="display:none;" onclick="openTeamModal()">üë• Manage Names</button>
    <button id="forceCommitBtn" class="btn btn-save" style="display:none; background:#3182ce;" onclick="saveToGitHub()">üöÄ Force Commit</button>
    <button id="adminBtn" class="btn btn-admin" onclick="toggleAdmin()">üîí Admin Login</button>
  </div>
</div>

<!-- Status Sections -->
<div class="status-section">
  <div class="section-header bg-working"><span>‚è≥ WORKING / IN-PROGRESS</span><span id="countWorking">0</span></div>
  <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-working"></tbody></table></div>
</div>

<div class="status-section">
  <div class="section-header bg-done"><span>‚úÖ COMPLETED</span><span id="countDone">0</span></div>
  <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-completed"></tbody></table></div>
</div>

<div class="status-section">
  <div class="section-header bg-stuck"><span>üõë STUCK / YET TO START</span><span id="countStuck">0</span></div>
  <div class="table-wrapper"><table><thead><tr class="hRow"></tr></thead><tbody id="tb-stuck"></tbody></table></div>
</div>

<script>
const GH_CONFIG = { owner: 'Studnit', repo: 'monday.com', dataPath: 'data.json', namePath: 'name.json' };
const GITHUB_TOKEN = "ghp_YOUR_TOKEN_HERE";

let DATA = [], TEAM_NAMES = [], HEADERS = [];
let admin = false;
let autosaveTimeout = null;

// Clock
function startClock() {
  setInterval(() => {
    document.getElementById('liveClock').innerText = "üìÖ " + new Date().toLocaleString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
  }, 1000);
}

// Load data from GitHub
async function loadData() {
  try {
    // Fetch team names
    const nameRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`);
    TEAM_NAMES = JSON.parse(atob((await nameRes.json()).content));
    renderNames();

    // Fetch data table
    const dataRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`);
    const content = JSON.parse(atob((await dataRes.json()).content));
    DATA = content.data || [];
    HEADERS = content.headers || [];
    renderHeaders(); renderBodies();
  } catch (e) {
    console.error("Sync Failed", e);
  }
}

// Render team names
function renderNames() {
  document.getElementById("namesContainer").innerHTML = TEAM_NAMES.map((n, i) => `
    <span class="name-pill">${n} <span style="cursor:pointer; color:red;" onclick="removeName(${i})">‚úñ</span></span>`).join('');
}

// Add new team member
function addNewName() {
  const val = document.getElementById("newNameInput").value.trim();
  if (val && !TEAM_NAMES.includes(val)) {
    TEAM_NAMES.push(val);
    TEAM_NAMES.sort();
    document.getElementById("newNameInput").value = "";
    renderNames();
    saveNamesToGitHub();
  }
}

// Remove team member
function removeName(i) {
  if (confirm("Remove?")) {
    TEAM_NAMES.splice(i, 1);
    renderNames();
    saveNamesToGitHub();
  }
}

// Save team names to GitHub
async function saveNamesToGitHub() {
  if (!admin) return;
  const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`;
  const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
  const file = await res.json();
  const payload = btoa(unescape(encodeURIComponent(JSON.stringify(TEAM_NAMES, null, 2))));
  await fetch(url, {
    method: 'PUT',
    headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
    body: JSON.stringify({ message: "Team Update", content: payload, sha: file.sha })
  });
}

// Render table headers
function renderHeaders() {
  const html = HEADERS.map(h => `<th>${h}</th>`).join('');
  document.querySelectorAll(".hRow").forEach(row => row.innerHTML = html);
}

// Render table bodies
function renderBodies() {
  const sections = {
    working: document.getElementById("tb-working"),
    done: document.getElementById("tb-completed"),
    stuck: document.getElementById("tb-stuck")
  };
  Object.values(sections).forEach(s => s.innerHTML = "");

  let counts = { working: 0, done: 0, stuck: 0 };
  const statusIdx = HEADERS.findIndex(h => h.toLowerCase().includes("status"));

  DATA.forEach((row, idx) => {
    const tr = document.createElement("tr");
    const sVal = (statusIdx !== -1 && row[statusIdx]) ? row[statusIdx].toLowerCase() : "";
    tr.innerHTML = row.map((cell, cIdx) => {
      const colHeader = HEADERS[cIdx].toLowerCase();
      let className = "";
      if (cell === "YES") className = "bg-yes";
      if (cell === "NO") className = "bg-no";

      if (cIdx === 0) {
        // Count per status
        if (sVal === "done") counts.done++;
        else if (sVal.includes("stuck") || sVal.includes("yet")) counts.stuck++;
        else counts.working++;
        return `<td>${counts[sVal === "done" ? "done" : (sVal.includes("stuck") || sVal.includes("yet") ? "stuck" : "working")]}</td>`;
      }

      // Status dropdown
      if (colHeader.includes("status") && !colHeader.includes("week")) {
        if (sVal === "done") className = "bg-done-cell";
        else if (sVal.includes("working")) className = "bg-working-cell";
        else if (sVal.includes("stuck") || sVal.includes("yet")) className = "bg-stuck-cell";

        return `<td class="${className}">
          <select onchange="updateCell(${idx}, ${cIdx}, this.value)" ${!admin ? 'disabled' : ''}>
            <option value="Working on it" ${row[cIdx]=='Working on it' ? 'selected':''}>Working</option>
            <option value="Done" ${row[cIdx]=='Done' ? 'selected':''}>Done</option>
            <option value="Stuck" ${row[cIdx]=='Stuck' ? 'selected':''}>Stuck</option>
          </select>
        </td>`;
      }

      // Date input
      if (colHeader.includes("date") && admin) {
        return `<td><input type="date" value="${cell}" onchange="updateCell(${idx}, ${cIdx}, this.value)"></td>`;
      }

      // Editable cell
      return `<td contenteditable="${admin}" class="${className}" oninput="updateCell(${idx}, ${cIdx}, this.innerText)">${cell}</td>`;
    }).join('');
    // Append row to appropriate section
    if (sVal === "done") sections.done.appendChild(tr);
    else if (sVal.includes("stuck") || sVal.includes("yet")) sections.stuck.appendChild(tr);
    else sections.working.appendChild(tr);
  });
  // Update counts
  document.getElementById("countWorking").innerText = counts.working;
  document.getElementById("countDone").innerText = counts.done;
  document.getElementById("countStuck").innerText = counts.stuck;
}

// Update cell value
function updateCell(rowIdx, colIdx, value) {
  DATA[rowIdx][colIdx] = value;
  if (HEADERS[colIdx].toLowerCase().includes("status")) renderBodies();
  clearTimeout(autosaveTimeout);
  autosaveTimeout = setTimeout(saveToGitHub, 2000);
}

// Save data to GitHub
async function saveToGitHub() {
  if (!admin) return;
  const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`;
  try {
    const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` }});
    const fileData = await res.json();
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify({ headers: HEADERS, data: DATA }, null, 2))));
    await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
      body: JSON.stringify({ message: "Sync", content: payload, sha: fileData.sha })
    });
    document.getElementById("syncStatus").innerText = "Sync: ‚úÖ Saved " + new Date().toLocaleTimeString();
  } catch (e) {
    console.error("Save failed", e);
  }
}

// Toggle admin mode
function toggleAdmin() {
  if (!admin && prompt("Pass:") === "admin123") {
    admin = true;
    document.getElementById("manageNamesBtn").style.display = "inline-block";
    document.getElementById("forceCommitBtn").style.display = "inline-block";
    document.getElementById("adminBtn").innerText = "üîì Logout";
  } else {
    admin = false;
    document.getElementById("manageNamesBtn").style.display = "none";
    document.getElementById("forceCommitBtn").style.display = "none";
    document.getElementById("adminBtn").innerText = "üîí Login";
  }
  renderBodies();
}

// Modal controls
function openTeamModal() {
  document.getElementById("teamModal").style.display = "flex";
}
function closeTeamModal() {
  document.getElementById("teamModal").style.display = "none";
}

// Initialize
window.onload = () => {
  startClock();
  loadData();
};
</script>
</body>
</html>
