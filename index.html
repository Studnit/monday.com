<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurus Tracker Pro | Fully Colored Excel Grid</title>
<style>
:root { --excel-green: #217346; --bg: #f4f7f6; --text: #1a202c; --border: #cbd5e0; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }

/* HEADER */
.header-container { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
#liveClock { font-weight: 700; color: #4a5568; background: #edf2f7; padding: 8px 15px; border-radius: 20px; font-size: 13px; }

/* TABLE WRAPPER & FREEZE */
.table-wrapper { overflow-x: auto; max-height: 50vh; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; min-width: 1600px; background: white; }
th { background: #34495e; color: white; font-size: 11px; text-transform: uppercase; padding: 12px; border: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }

/* Frozen Columns Styles */
th:nth-child(-n+3), td:nth-child(-n+3) { position: sticky; left: 0; z-index: 5; border-right: 2px solid var(--border); }
th:nth-child(2), td:nth-child(2) { left: 60px; } 
th:nth-child(3), td:nth-child(3) { left: 140px; }
th:nth-child(-n+3) { z-index: 11; }

/* Cell Colors */
td { padding: 8px; border: 1px solid var(--border); font-size: 13px; text-align: center; color: #2d3748; }
td:nth-child(1) { background: #ebf5fb; font-weight: bold; } /* SR NO */
td:nth-child(2) { background: #fdf2f2; } /* EP ID */
td:nth-child(3) { background: #e8f4fd; text-align: left; font-weight: 600; } /* Name */

/* Heatmap Classes */
.bg-yes { background-color: #2ecc71 !important; color: white !important; font-weight: bold; }
.bg-no { background-color: #e74c3c !important; color: white !important; font-weight: bold; }
.bg-na { background-color: #bdc3c7 !important; color: #2c3e50 !important; }
.bg-working { background-color: #f39c12 !important; color: white !important; font-weight: bold; }
.bg-done { background-color: #27ae60 !important; color: white !important; font-weight: bold; }
.bg-stuck { background-color: #c0392b !important; color: white !important; font-weight: bold; }

/* INPUTS */
select, input[type="date"] { width: 100%; border: none; background: transparent; font-family: inherit; text-align: center; cursor: pointer; }
.btn-admin { background: #2d3748; color: #fff; padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
#syncStatus { font-size: 11px; font-weight: bold; color: #718096; margin-left: 10px; }
</style>
</head>
<body>

<div class="header-container">
  <div>
    <h1>Aurus Certification <span style="color:var(--excel-green)">Grid Pro</span></h1>
    <div style="display:flex; gap:15px; margin-top:5px; align-items:center;">
        <div id="liveClock">Loading Clock...</div>
        <div id="syncStatus">Sync: Ready</div>
    </div>
  </div>
  <div style="display:flex; gap:10px;">
    <button id="adminSaveBtn" class="btn-admin" style="display:none; background:var(--excel-green);" onclick="saveToGitHub()">ðŸš€ Force Commit</button>
    <button id="adminBtn" class="btn-admin" onclick="toggleAdmin()">ðŸ”’ Admin Login</button>
  </div>
</div>

<div class="table-wrapper">
    <table>
        <thead><tr class="hRow"></tr></thead>
        <tbody id="mainBody"></tbody>
    </table>
</div>

<script>
const GH_CONFIG = { owner: 'Studnit', repo: 'monday.com', dataPath: 'data.json', namePath: 'name.json' };
const GITHUB_TOKEN = "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"; 

let DATA = [], TEAM_NAMES = [], HEADERS = [];
let admin = false, autosaveTimer = null;

function startClock() {
    setInterval(() => {
        document.getElementById('liveClock').innerText = "ðŸ“… " + new Date().toLocaleString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
    }, 1000);
}

async function loadData() {
    try {
        const nameRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`);
        TEAM_NAMES = JSON.parse(atob((await nameRes.json()).content));

        const dataRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`);
        const content = JSON.parse(atob((await dataRes.json()).content));
        DATA = content.data || [];
        HEADERS = content.headers || [];
        
        renderHeaders(); renderBodies();
    } catch (e) { console.error("Sync Failed"); }
}

function renderHeaders() {
    document.querySelector(".hRow").innerHTML = HEADERS.map(h => `<th>${h}</th>`).join('');
}

function renderBodies() {
    const body = document.getElementById("mainBody");
    body.innerHTML = "";
    
    DATA.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = r.map((cell, cIdx) => {
            const h = HEADERS[cIdx].toLowerCase();
            let colorCls = "";
            
            // Conditional Formatting Logic
            if (cell === "YES") colorCls = "bg-yes";
            else if (cell === "NO") colorCls = "bg-no";
            else if (cell === "NA") colorCls = "bg-na";
            
            if (h.includes("status") && !h.includes("week")) {
                if (cell === "Done") colorCls = "bg-done";
                else if (cell === "Working on it") colorCls = "bg-working";
                else if (cell === "Stuck") colorCls = "bg-stuck";
                
                return `<td class="${colorCls}"><select onchange="updateCell(${idx}, ${cIdx}, this.value)" ${!admin ? 'disabled' : ''}>
                    <option value="Working on it" ${cell==='Working on it'?'selected':''}>Working</option>
                    <option value="Done" ${cell==='Done'?'selected':''}>Done</option>
                    <option value="Stuck" ${cell==='Stuck'?'selected':''}>Stuck</option>
                    <option value="Yet to Start" ${cell==='Yet to Start'?'selected':''}>Yet to Start</option>
                </select></td>`;
            }

            if ((h.includes("week") || h.includes("feb")) && admin) {
                return `<td class="${colorCls}"><select onchange="updateCell(${idx}, ${cIdx}, this.value)" class="${colorCls}">
                    <option value=""></option><option value="YES" ${cell==='YES'?'selected':''}>YES</option>
                    <option value="NO" ${cell==='NO'?'selected':''}>NO</option><option value="NA" ${cell==='NA'?'selected':''}>NA</option>
                </select></td>`;
            }

            return `<td contenteditable="${admin}" class="${colorCls}" oninput="updateCell(${idx}, ${cIdx}, this.innerText)">${cell}</td>`;
        }).join('');
        body.appendChild(tr);
    });
}

function updateCell(rIdx, cIdx, val) {
    DATA[rIdx][cIdx] = val;
    renderBodies(); // Re-render to update colors instantly
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(saveToGitHub, 2000);
}

async function saveToGitHub() {
    if (!admin) return;
    document.getElementById("syncStatus").innerText = "Sync: ðŸ“¤ Saving...";
    const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` }});
        const fileData = await res.json();
        const payload = btoa(unescape(encodeURIComponent(JSON.stringify({ headers: HEADERS, data: DATA }, null, 2))));
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Color Grid Sync", content: payload, sha: fileData.sha })
        });
        document.getElementById("syncStatus").innerText = "Sync: âœ… Saved " + new Date().toLocaleTimeString();
    } catch (e) { document.getElementById("syncStatus").innerText = "Sync: âŒ Error"; }
}

function toggleAdmin() {
    if(!admin && prompt("Admin Pass:") === "admin123") { 
        admin = true; 
        document.getElementById("adminSaveBtn").style.display = "block";
    } else { admin = false; document.getElementById("adminSaveBtn").style.display = "none"; }
    renderBodies();
}

window.onload = () => { startClock(); loadData(); };
</script>
</body>
</html>
