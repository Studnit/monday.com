<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurus Tracker Pro | Admin Edit Edition</title>
    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f8fafc; 
            --surface: #ffffff; 
            --border: #e2e8f0; 
            --text: #1e293b; 
            --text-light: #64748b;
            --st-working: #ffad33; 
            --st-done: #00ca72;    
            --st-stuck: #df2f4a;   
            --st-yet: #94a3b8;     
            --wk-yes-bg: #c6f6d5; --wk-yes-txt: #22543d;
            --wk-no-bg: #fed7d7;  --wk-no-txt: #822727;
            --wk-na-bg: #f1f5f9;  --wk-na-txt: #475569;
        }

        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }

        /* UI COMPONENTS */
        .header-main { background: var(--surface); padding: 15px 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .search-bar { background: #f1f5f9; border: 1px solid var(--border); padding: 8px 15px; border-radius: 8px; width: 300px; outline: none; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-green { background: var(--st-done); color: white; border: none; }
        .btn-amber { background: #f59e0b; color: white; border: none; }

        /* TABLE STYLING */
        .table-section { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .table-header { padding: 12px 20px; font-weight: 800; color: white; display: flex; justify-content: space-between; align-items: center; }
        .scroll-area { overflow: auto; max-height: 500px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; min-width: 1700px; }

        /* STICKY COLUMNS */
        thead th { position: sticky; top: 0; z-index: 50; background: #f1f5f9; color: var(--text-light); padding: 12px; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); }
        td:nth-child(1), th:nth-child(1) { position: sticky; left: 0; z-index: 40; background: #f8fafc !important; width: 50px; text-align: center; }
        td:nth-child(2), th:nth-child(2) { position: sticky; left: 50px; z-index: 40; background: #f8fafc !important; width: 110px; }
        td:nth-child(3), th:nth-child(3) { position: sticky; left: 160px; z-index: 40; background: #fff !important; text-align: left; border-right: 3px solid var(--primary) !important; font-weight: 700; width: 420px; }
        
        td { padding: 10px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); font-size: 13px; background: #fff; }

        /* ADMIN EDITABLE STYLE */
        .admin-on [contenteditable="true"] { background: #fffdf0; outline: 1px dashed #2563eb; cursor: text; }
        .admin-on [contenteditable="true"]:focus { background: #fff; outline: 2px solid #2563eb; }

        /* STATUS COLORS */
        .st-working { background-color: var(--st-working) !important; color: white !important; }
        .st-done { background-color: var(--st-done) !important; color: white !important; }
        .st-stuck { background-color: var(--st-stuck) !important; color: white !important; }
        .st-yet { background-color: var(--st-yet) !important; color: white !important; }
        .wk-yes { background-color: var(--wk-yes-bg) !important; color: var(--wk-yes-txt) !important; }
        .wk-no { background-color: var(--wk-no-bg) !important; color: var(--wk-no-txt) !important; }
        .wk-na { background-color: var(--wk-na-bg) !important; color: var(--wk-na-txt) !important; }

        .status-select { border-radius: 4px; border: none; padding: 6px; width: 100%; font-weight: 700; cursor: pointer; text-align: center; outline: none; }
        input.cell-input { width: 100%; border: none; background: transparent; text-align: center; font-family: inherit; font-size: 13px; color: inherit; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10001; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 450px; }
    </style>
</head>
<body class="admin-off" id="bodyTag">

<datalist id="teamNamesList"></datalist>

<div id="nameModal" class="modal">
    <div class="modal-content">
        <h3>üë• Team Management</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="newNameInput" placeholder="Add Name..." style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1">
            <button class="btn btn-primary" onclick="addNewName()">Add</button>
        </div>
        <div id="namesContainer" style="max-height:200px; overflow-y:auto; margin-bottom:20px; border:1px solid #eee; padding:10px; border-radius:8px;"></div>
        <div style="text-align:right"><button class="btn" onclick="toggleModal(false)">Close</button></div>
    </div>
</div>

<header class="header-main">
    <div>
        <h2 style="margin:0">Aurus <span style="color:var(--primary)">Grid Pro</span></h2>
        <div id="liveClock" style="font-size: 12px; color: var(--text-light); margin-top: 5px;"></div>
    </div>
    <input type="text" id="globalSearch" class="search-bar" placeholder="üîç Search Grid..." oninput="renderGrid()">
    <div class="btn-group">
        <button class="btn btn-amber" onclick="exportToExcel()">üìä Export Excel</button>
        <button class="btn" id="btnManage" style="display:none" onclick="toggleModal(true)">üë• Team</button>
        <button class="btn btn-green" id="btnCommit" style="display:none" onclick="saveToGitHub(true)">üöÄ Sync</button>
        <button class="btn btn-primary" onclick="toggleAdmin()" id="adminBtn">üîí Admin Login</button>
    </div>
</header>

<section class="table-section">
    <div class="table-header" style="background: var(--st-working)"><span>‚è≥ WORKING</span><span id="countWorking">0</span></div>
    <div class="scroll-area"><table id="tbl-working"><thead><tr class="hRow"></tr></thead><tbody></tbody></table></div>
</section>

<section class="table-section">
    <div class="table-header" style="background: var(--st-done)"><span>‚úÖ COMPLETED</span><span id="countDone">0</span></div>
    <div class="scroll-area"><table id="tbl-done"><thead><tr class="hRow"></tr></thead><tbody></tbody></table></div>
</section>

<section class="table-section">
    <div class="table-header" style="background: var(--st-stuck)"><span>üõë STUCK / YET</span><span id="countStuck">0</span></div>
    <div class="scroll-area"><table id="tbl-stuck"><thead><tr class="hRow"></tr></thead><tbody></tbody></table></div>
</section>

<script>
const GITHUB_TOKEN = "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"; 
const GH_CONFIG = { owner: 'Studnit', repo: 'monday.com', dataPath: 'data.json', namePath: 'name.json' };

let DATA = [], HEADERS = [], TEAM_NAMES = [], admin = false;

async function loadData() {
    try {
        const nRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`);
        TEAM_NAMES = JSON.parse(atob((await nRes.json()).content));
        renderNames();
        
        const dRes = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`);
        const content = JSON.parse(atob((await dRes.json()).content));
        DATA = content.data || [];
        HEADERS = content.headers || ["SR", "EP ID", "Certification Name", "Start", "End", "Status", "Developer", "Lead", "Week Status"];
        renderHeaders(); renderGrid();
    } catch (e) { console.error("Sync Error"); }
}

function renderHeaders() {
    const html = HEADERS.map(h => `<th>${h}</th>`).join('');
    document.querySelectorAll(".hRow").forEach(r => r.innerHTML = html);
}

function renderGrid() {
    const term = document.getElementById('globalSearch').value.toLowerCase();
    const bodies = { working: document.querySelector("#tbl-working tbody"), done: document.querySelector("#tbl-done tbody"), stuck: document.querySelector("#tbl-stuck tbody") };
    Object.values(bodies).forEach(b => b.innerHTML = "");
    let counts = { w: 0, d: 0, s: 0 };

    DATA.forEach((row, rIdx) => {
        const matches = row.some(cell => String(cell).toLowerCase().includes(term));
        if (!matches) return;

        const status = (row[5] || "").toLowerCase();
        const tr = document.createElement("tr");

        tr.innerHTML = row.map((cell, cIdx) => {
            // Column 0: SR (Not editable)
            if (cIdx === 0) return `<td>${rIdx + 1}</td>`;
            
            // Column 5: Main Status
            if (cIdx === 5) {
                let badge = status === "done" ? "st-done" : (status.includes("work") ? "st-working" : (status.includes("stuck") ? "st-stuck" : "st-yet"));
                return `<td class="${badge}">
                    <select class="status-select ${badge}" onchange="updateRow(${rIdx}, ${cIdx}, this.value)" ${!admin?'disabled':''}>
                        <option value="Working on it" ${row[5].includes("Work")?'selected':''}>Working on it</option>
                        <option value="Done" ${row[5]==='Done'?'selected':''}>Done</option>
                        <option value="Stuck" ${row[5]==='Stuck'?'selected':''}>Stuck</option>
                        <option value="Yet to Start" ${row[5].includes("Yet")?'selected':''}>Yet to Start</option>
                    </select>
                </td>`;
            }
            
            // Column 8: Weekly Status
            if (cIdx === 8) {
                let wkCls = cell === "YES" ? "wk-yes" : (cell === "NO" ? "wk-no" : "wk-na");
                return `<td class="${wkCls}">
                    <select class="status-select ${wkCls}" onchange="updateRow(${rIdx}, ${cIdx}, this.value)" ${!admin?'disabled':''}>
                        <option value="YES" ${cell==='YES'?'selected':''}>YES</option>
                        <option value="NO" ${cell==='NO'?'selected':''}>NO</option>
                        <option value="NA" ${cell==='NA'?'selected':''}>NA</option>
                    </select>
                </td>`;
            }

            // Columns 6 & 7: Developer/Lead
            if (cIdx === 6 || cIdx === 7) {
                return `<td>
                    <input class="cell-input" list="teamNamesList" value="${cell}" 
                           onchange="updateRow(${rIdx}, ${cIdx}, this.value)" ${!admin?'disabled':''}>
                </td>`;
            }

            // All other columns (EP ID, Name, Start, End)
            return `<td contenteditable="${admin}" onblur="updateRow(${rIdx}, ${cIdx}, this.innerText)">${cell}</td>`;
        }).join('');

        if (status === "done") { bodies.done.appendChild(tr); counts.d++; }
        else if (status.includes("stuck") || status.includes("yet")) { bodies.stuck.appendChild(tr); counts.s++; }
        else { bodies.working.appendChild(tr); counts.w++; }
    });
    
    document.getElementById("countWorking").innerText = counts.w;
    document.getElementById("countDone").innerText = counts.d;
    document.getElementById("countStuck").innerText = counts.s;
}

function updateRow(rIdx, cIdx, val) {
    if (DATA[rIdx][cIdx] === val) return;
    DATA[rIdx][cIdx] = val;
    if (cIdx === 5 || cIdx === 8) renderGrid(); 
    saveToGitHub(false);
}

async function saveToGitHub(force) {
    if (!admin) return;
    try {
        const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.dataPath}`;
        const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` }});
        const file = await res.json();
        const payload = btoa(unescape(encodeURIComponent(JSON.stringify({ headers: HEADERS, data: DATA }, null, 2))));
        await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_TOKEN}` }, body: JSON.stringify({ message: "Update", content: payload, sha: file.sha }) });
        if(force) alert("Sync Successful!");
    } catch (e) { console.error("Sync Failed"); }
}

function toggleAdmin() {
    if(!admin && prompt("Admin Pass:") === "admin123") {
        admin = true;
        document.getElementById("bodyTag").className = "admin-on";
        document.getElementById("btnManage").style.display = "block";
        document.getElementById("btnCommit").style.display = "block";
    } else { 
        admin = false; 
        document.getElementById("bodyTag").className = "admin-off";
        document.getElementById("btnManage").style.display = "none"; 
        document.getElementById("btnCommit").style.display = "none"; 
    }
    document.getElementById("adminBtn").innerText = admin ? "üîì Logout" : "üîí Admin Login";
    renderGrid();
}

function exportToExcel() {
    let csv = HEADERS.join(",") + "\n";
    DATA.forEach(r => csv += r.map(c => `"${c}"`).join(",") + "\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Aurus_Tracker.csv`; a.click();
}

function toggleModal(show) { document.getElementById('nameModal').style.display = show ? 'flex' : 'none'; }
function renderNames() {
    document.getElementById('namesContainer').innerHTML = TEAM_NAMES.map((n, i) => `<span class="name-pill">${n} <span style="cursor:pointer;color:red" onclick="removeName(${i})">‚úñ</span></span>`).join('');
    document.getElementById('teamNamesList').innerHTML = TEAM_NAMES.map(n => `<option value="${n}">`).join('');
}
function addNewName() {
    const val = document.getElementById('newNameInput').value.trim();
    if(val && !TEAM_NAMES.includes(val)) { TEAM_NAMES.push(val); document.getElementById('newNameInput').value = ""; renderNames(); saveNames(); }
}
async function saveNames() {
    const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.namePath}`;
    const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` }});
    const file = await res.json();
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(TEAM_NAMES))));
    await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_TOKEN}` }, body: JSON.stringify({ message: "Names Update", content: payload, sha: file.sha }) });
}

window.onload = () => { loadData(); setInterval(() => { document.getElementById('liveClock').innerText = "üïí " + new Date().toLocaleTimeString(); }, 1000); };
</script>
</body>
</html>
